<!DOCTYPE html>
<html>
<head>
    <title>Institute of Entrepreneurship Development, Bihar</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f9f9f9; }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .batch-section { border: 2px solid #333; padding: 15px; margin-bottom: 25px; }
        .session-row { display: grid; grid-template-columns: 200px 1fr 1fr; gap: 15px; margin: 15px 0; align-items: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #333; padding: 10px; text-align: left; vertical-align: top; }
        th { background-color: #f0f0f0; }
        select, input[type="date"], input[type="text"], input[type="tel"] { width: 100%; padding: 8px; border: 1px solid #ccc; margin-bottom: 10px; }
        h1 { text-align:center; font-weight:bold; margin-bottom:0; }
        .title2 { text-align:center; font-weight:bold; font-size:1.5em; margin-top:0.2em; margin-bottom:1em; }
        .session-title { font-weight: bold; }
        .batch-header { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 20px; margin-bottom: 10px; align-items: end; }
        .batch-header label { font-weight: bold; }
        #addTrainerBtn, #removeTrainerBtn, #removeAllDataBtn, #exportDataBtn, #adminLoginBtn {
            margin: 10px 0;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #addTrainerBtn { background: #28a745; color: white; }
        #removeTrainerBtn { background: #dc3545; color: white; }
        #removeAllDataBtn { background: #dc3545; color: white; }
        #exportDataBtn { background: #007bff; color: white; }
        #adminLoginBtn { background: #6c757d; color: white; }
        #reportModal, #adminLoginModal, #authStatusModal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        #reportModal .modal-content, #adminLoginModal .modal-content, #authStatusModal .modal-content {
            background: #fff;
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
            border: 2px solid #007bff;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        #reportModal .modal-content button, #adminLoginModal .modal-content button, #authStatusModal .modal-content button { margin-top: 20px; }
        #reportModal .modal-content .close-btn, #adminLoginModal .modal-content .close-btn, #authStatusModal .modal-content .close-btn {
            position:absolute; top:10px; right:10px; background:#dc3545; color:#fff; border:none; border-radius:4px; padding:5px 12px; font-size:16px;
        }
        #newTrainerModal, #removeTrainerModal, #removeAllDataModal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        #newTrainerModal .modal-content, #removeTrainerModal .modal-content, #removeAllDataModal .modal-content {
            background: #fff;
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
            border: 2px solid #007bff;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        #newTrainerModal label, #removeTrainerModal label, #removeAllDataModal label { display: block; margin-top: 10px; }
        #newTrainerModal input, #removeTrainerModal select, #removeAllDataModal input { width: 100%; padding: 8px; border: 1px solid #ccc; margin-bottom: 10px; }
        #newTrainerModal button, #removeTrainerModal button, #removeAllDataModal button { margin-top: 10px; }
        .button-row { margin: 20px 0; }
        .page-break { page-break-after: always; }
        .summary-header { margin-bottom: 20px; }
        .summary-table { margin-bottom: 30px; }
        .cell-topic { font-weight: bold; }
        .cell-trainer { font-size: 0.9em; color: #555; }
        .signature-block { margin-top: 40px; }
        .signature-line { border-top: 1px solid #000; width: 80%; margin: 0 auto; padding-top: 40px; }
        .analytics-section { margin-top: 30px; border-top: 2px solid #333; padding-top: 20px; }
        #analyticsResult { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9; }
        .session-row .topic {
            white-space: pre-wrap;
            max-width: 300px;
            padding: 8px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .locked-notice {
            color: #dc3545;
            font-weight: bold;
            margin: 10px 0;
        }
        #authStatus {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #e9ecef;
        }
        #authStatus.authenticated {
            background: #d4edda;
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <button id="addTrainerBtn">‚ûï Add New Trainer</button>
    <button id="removeTrainerBtn">‚úñ Remove Trainer</button>
    <button id="removeAllDataBtn">‚úñ Remove All Training Data</button>
    <button id="exportDataBtn">üì§ Export Training Data</button>
    <button id="adminLoginBtn">üîê Admin Login</button>
    <div id="authStatus">Not logged in as admin.</div>
    <div class="button-row">
        <button onclick="generateDailyReport()">üìù Generate Daily Report</button>
        <button onclick="generateWeeklyReport()">üìù Generate Weekly Report</button>
        <button onclick="generate7DaySummary()">üìù Generate 7-Day Summary</button>
        <button onclick="generateMonthlySummary()">üìù Generate Monthly Summary</button>
    </div>
    <div id="reportModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeReportModal()">‚úñ</button>
            <div id="reportBody"></div>
            <button onclick="printReport()" style="background:#28a745; color:#fff; border:none; border-radius:4px; padding:8px 18px;">üñ®Ô∏è Print</button>
        </div>
    </div>
    <div id="adminLoginModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeAdminLoginModal()">‚úñ</button>
            <h3>Admin Login</h3>
            <form id="adminLoginForm">
                <label for="adminEmail">Admin Email</label>
                <input type="email" id="adminEmail" required value="ranjannerve24@gmail.com">
                <button type="submit">Send Login Link</button>
                <button type="button" onclick="closeAdminLoginModal()" style="background:#bbb;color:#222;">Cancel</button>
            </form>
        </div>
    </div>
    <div id="authStatusModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeAuthStatusModal()">‚úñ</button>
            <h3>Authentication Status</h3>
            <div id="authStatusModalBody"></div>
            <button onclick="closeAuthStatusModal()" style="background:#bbb;color:#222;">Close</button>
        </div>
    </div>
    <div id="newTrainerModal">
        <div class="modal-content">
            <h3>Register New Trainer</h3>
            <form id="newTrainerForm">
                <label for="nt_name">Full Name</label>
                <input type="text" id="nt_name" required>
                <label for="nt_mobile">Mobile No</label>
                <input type="text" id="nt_mobile" required pattern="[0-9]{10,}">
                <label for="nt_bank">Bank Account No</label>
                <input type="text" id="nt_bank" required>
                <label for="nt_ifsc">IFSC Code</label>
                <input type="text" id="nt_ifsc" required style="text-transform:uppercase">
                <button type="submit">Register</button>
                <button type="button" onclick="closeNewTrainerModal()" style="background:#bbb;color:#222;">Cancel</button>
            </form>
        </div>
    </div>
    <div id="removeTrainerModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeRemoveTrainerModal()">‚úñ</button>
            <h3>Remove Trainer</h3>
            <form id="removeTrainerForm">
                <label for="rt_id">Trainer Name</label>
                <select id="rt_id" required>
                    <option value="">Select Trainer</option>
                </select>
                <button type="submit">Remove</button>
                <button type="button" onclick="closeRemoveTrainerModal()" style="background:#bbb;color:#222;">Cancel</button>
            </form>
        </div>
    </div>
    <div id="removeAllDataModal">
        <div class="0-content">
            <button class="close-btn" onclick="closeRemoveAllDataModal()">‚úñ</button>
            <h3>Remove All Training Data</h3>
            <p>Are you sure you want to delete all training data (trainers and sessions)? This action cannot be undone.</p>
            <p>Please ensure you have saved all necessary reports before proceeding.</p>
            <button onclick="removeAllTrainingData()" style="background:#dc3545; color:#fff; border:none; border-radius:4px; padding:8px 18px; margin-right:10px;">Yes, Delete All</button>
            <button onclick="closeRemoveAllDataModal()" style="background:#bbb; color:#222; border:none; border-radius:4px; padding:8px 18px;">Cancel</button>
        </div>
    </div>
    <h1>Institute of Entrepreneurship Development, Bihar</h1>
    <div class="title2">TRAINER ATTENDANCE SYSTEM</div>
    <div class="container" id="printArea">
        <div class="batch-section">
            <div class="batch-header">
                <div>
                    <label for="batchNo">Room No:</label>
                    <select id="batchNo" onchange="updateSessions()">
                        <option value="1">Room 1</option>
                        <option value="2">Room 2</option>
                        <option value="3">Room 3</option>
                        <option value="4">Room 4</option>
                    </select>
                </div>
                <div>
                    <label for="batchPhase">Phase:</label>
                    <select id="batchPhase" onchange="updateDays()">
                        <option value="">Select Phase</option>
                        <option value="Phase 1">Phase 1</option>
                        <option value="Phase 2">Phase 2</option>
                    </select>
                </div>
                <div>
                    <label for="startDate">Training Start:</label>
                    <input type="date" id="startDate">
                </div>
                <div>
                    <label for="endDate">Training End:</label>
                    <input type="date" id="endDate">
                </div>
                <div>
                    <label for="dayNo">Day:</label>
                    <select id="dayNo" onchange="updateSessions()">
                        <option value="">Select Day</option>
                    </select>
                </div>
            </div>
            <div id="sessions"></div>
        </div>
    </div>
    <div class="analytics-section">
        <h3>Analytics Dashboard</h3>
        <div>
            <label for="analyticsTrainer">Trainer Name:</label>
            <select id="analyticsTrainer">
                <option value="">Select Trainer</option>
            </select>
            <button onclick="showSessionsByTrainer()">Show Sessions</button>
            <button onclick="showPastMonthSessions()">Past Month Sessions</button>
            <button onclick="showAverageSessions()">Average Sessions per Trainer</button>
            <button onclick="showTotalSessionsInMonth()">Total Sessions in Month</button>
            <button onclick="exportTrainerMasterData()">Export Trainer Master Data</button>
        </div>
        <div id="analyticsResult"></div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAszMZl49AWHMXhzFfSgs5fntuwzI77yUA",
            authDomain: "ied-bihar-trainer-attendance.firebaseapp.com",
            projectId: "ied-bihar-trainer-attendance",
            storageBucket: "ied-bihar-trainer-attendance.firebasestorage.app",
            messagingSenderId: "453183582278",
            appId: "1:453183582278:web:f29e94b4ea76eb74239a47"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Update authentication status display
        function updateAuthStatus(user) {
            const authStatus = document.getElementById('authStatus');
            if (user && user.email === 'ranjannerve24@gmail.com') {
                authStatus.textContent = `Logged in as admin: ${user.email}`;
                authStatus.className = 'authenticated';
            } else {
                authStatus.textContent = 'Not logged in as admin.';
                authStatus.className = '';
            }
        }

        // Listen for auth state changes
        auth.onAuthStateChanged(user => {
            updateAuthStatus(user);
        });

        // Admin login modal functions
        function showAdminLoginModal() {
            document.getElementById('adminLoginModal').style.display = 'block';
        }
        function closeAdminLoginModal() {
            document.getElementById('adminLoginModal').style.display = 'none';
        }
        function showAuthStatusModal(msg) {
            document.getElementById('authStatusModalBody').textContent = msg;
            document.getElementById('authStatusModal').style.display = 'block';
        }
        function closeAuthStatusModal() {
            document.getElementById('authStatusModal').style.display = 'none';
        }

        // Send admin login link
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value.trim();
            if (!email) {
                showAuthStatusModal('Please enter an email address.');
                return;
            }
            const actionCodeSettings = {
                url: 'https://ied-bihar-trainer-attendance.web.app',
                handleCodeInApp: true
            };
            try {
                await auth.sendSignInLinkToEmail(email, actionCodeSettings);
                window.localStorage.setItem('emailForSignIn', email);
                showAuthStatusModal('Login link sent to your email. Check your inbox and follow the link to sign in.');
            } catch (error) {
                showAuthStatusModal('Error sending login link: ' + error.message);
            }
        });

        // Check if this is a sign-in with email link
        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn');
            if (!email) {
                email = prompt('Please provide your email for confirmation');
            }
            if (email) {
                auth.signInWithEmailLink(email, window.location.href)
                    .then(result => {
                        window.localStorage.removeItem('emailForSignIn');
                        updateAuthStatus(result.user);
                        showAuthStatusModal('Successfully logged in as admin.');
                        // Remove the email link params from the URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    })
                    .catch(error => {
                        showAuthStatusModal('Error signing in: ' + error.message);
                    });
            }
        }

        // Helper function to format date to DD-MM-YYYY
        function formatDateToDDMMYYYY(dateStr) {
            if (!dateStr) return "";
            const date = new Date(dateStr);
            if (isNaN(date)) return dateStr;
            let dd = String(date.getDate()).padStart(2, '0');
            let mm = String(date.getMonth() + 1).padStart(2, '0');
            const yyyy = date.getFullYear();
            return dd + '-' + mm + '-' + yyyy;
        }

        // Session data for each phase and day
        const sessionData = {
            "Phase 1": {
                "Day 1": [
                    "Document Verification",
                    "Introduction of MMUY",
                    "Brief Introduction of MMUY Projects & DPR",
                    "New Venture Establishment and Management"
                ],
                "Day 2": [
                    "Selection of Workplace / Preparation of Work Shed",
                    "Utilization of Funds / Procurement",
                    "Portal Utilization & Loan Repayment",
                    "Entrepreneurial Leadership and Business Ethics"
                ],
                "Day 3": [
                    "MSME",
                    "Government Financial Schemes",
                    "Banking & Financial Management",
                    "Team Building"
                ],
                "Day 4": [
                    "Accounting & Daily Book-keeping",
                    "GST and Taxation",
                    "Trademark & IPR Management",
                    "Electric Connection/Consumption & Solar Power"
                ],
                "Day 5": [
                    "Marketing & Digital Marketing",
                    "Branding & Packaging",
                    "Advertisement of Products",
                    "Licenses & Standardization"
                ],
                "Day 6": [
                    "Project Presentation & Evaluation",
                    "Udyami/ZED/GEM/ONDC/Lean",
                    "Motivational Talk/Experience Sharing",
                    "Certificate Distribution"
                ]
            },
            "Phase 2": {
                "Day 1": [
                    "Introduction of MMUY & MSME",
                    "Utilization of Fund/ Procurement of Machinery & Raw Material/Sector Specific Government Policies",
                    "Case Studies of Businesses/Global Perspective of the Business",
                    "Business Communication and Soft Skills"
                ],
                "Day 2": [
                    "Business Laws and Statutory Business Registrations",
                    "Trademark Registration & IPR Management/Pre and Post Operating Licenses",
                    "Computer Fundamentals- MS Excel, Powerpoint, Word",
                    "Entrepreneurship Psychology/Entrepreneurial Leadership and Business ethics/Team Building"
                ],
                "Day 3": [
                    "Operations Management/Logistics/Supply Chain Management",
                    "Seminars/Melas/National and International Exhibitions",
                    "Marketing/ Digital Marketing/Advertisement",
                    "Sustainability and Growth of Business/Business Evaluation & Feedback/Business Insurance"
                ],
                "Day 4": [
                    "Daily book keeping/ Accounting- Tally/Auditing",
                    "Role-Playing/Customer Relationship Management",
                    "Sales/Human Management/Production Management",
                    "Digitalization and Use of Technology in Business"
                ],
                "Day 5": [
                    "Domain Specific Training",
                    "Domain Specific Training",
                    "Exposure Visit",
                    "Exposure Visit"
                ],
                "Day 6": [
                    "Banking / Financial Management /GST and Taxation",
                    "Branding & Packaging",
                    "Experience Sharing/Group Discussion",
                    "Certificate Distribution"
                ]
            }
        };

        let batchData = {};
        for (let b = 1; b <= 4; b++) {
            batchData[b] = {};
            for (let d = 1; d <= 6; d++) {
                batchData[b][d] = {
                    phase: "",
                    startDate: "",
                    endDate: "",
                    sessions: Array(4).fill({ trainer: "", topic: "" })
                };
            }
        }

        function getCurrentBatch() { return document.getElementById('batchNo').value; }
        function getCurrentDay() { 
            let day = document.getElementById('dayNo').value;
            return day.replace("Day ", "");
        }
        function getCurrentPhase() { return document.getElementById('batchPhase').value; }

        // Add days, skipping Sundays
        function addDaysSkipSundays(startDateStr, daysToAdd) {
            let date = new Date(startDateStr);
            let addedDays = 0;
            while (addedDays < daysToAdd) {
                date.setDate(date.getDate() + 1);
                if (date.getDay() !== 0) {
                    addedDays++;
                }
            }
            return date;
        }

        // Fetch trainers from Firestore
        async function fetchTrainers() {
            try {
                const snapshot = await db.collection('trainers').orderBy('createdAt', 'desc').get();
                const trainers = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                return trainers;
            } catch (error) {
                console.error('Error fetching trainers:', error);
                return [];
            }
        }

        // Update trainer dropdowns
        async function updateTrainerDropdowns() {
            const trainers = await fetchTrainers();
            const selects = document.querySelectorAll('select.trainer');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select Trainer</option>';
                trainers.forEach(t => {
                    select.innerHTML += `<option value="${t.name}" ${t.name===select.value?'selected':''}>${t.name}</option>`;
                });
            });
            // Update remove trainer dropdown
            const removeSelect = document.getElementById('rt_id');
            removeSelect.innerHTML = '<option value="">Select Trainer</option>';
            trainers.forEach(t => {
                removeSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
            });
            // Update analytics trainer dropdown
            const analyticsSelect = document.getElementById('analyticsTrainer');
            analyticsSelect.innerHTML = '<option value="">Select Trainer</option>';
            trainers.forEach(t => {
                analyticsSelect.innerHTML += `<option value="${t.name}">${t.name}</option>`;
            });
        }

        // Update days dropdown based on selected phase
        function updateDays() {
            const phase = document.getElementById('batchPhase').value;
            const daySelect = document.getElementById('dayNo');
            daySelect.innerHTML = '<option value="">Select Day</option>';
            if (phase === "Phase 1" || phase === "Phase 2") {
                for (let i = 1; i <= 6; i++) {
                    const option = document.createElement('option');
                    option.value = "Day " + i;
                    option.textContent = "Day " + i;
                    daySelect.appendChild(option);
                }
            }
            updateSessions();
        }

        // Check if a day is locked in Firestore
        async function isDayLocked(batchNo, phase, day) {
            const docId = `${batchNo}_${phase}_${day}`;
            const docRef = db.collection('dayLocks').doc(docId);
            const doc = await docRef.get();
            return doc.exists && doc.data().locked;
        }

        // Lock a day in Firestore
        async function lockDay(batchNo, phase, day) {
            const docId = `${batchNo}_${phase}_${day}`;
            await db.collection('dayLocks').doc(docId).set({ locked: true, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        }

        // Unlock a day (admin override)
        async function requestEditUnlock(batchNo, phase, day) {
            const user = auth.currentUser;
            if (!user || user.email !== 'ranj1340@gmail.com') { // Correct this to your admin email if needed
                alert("Only admin can unlock this day. Please log in as admin.");
                return false;
            }
            const docId = `${batchNo}_${phase}_${day}`;
            await db.collection('dayLocks').doc(docId).set({ locked: false }, { merge: true });
            alert("Day unlocked. You can now edit the sessions.");
            return true;
        }

        // Update sessions based on selected day and phase
        async function updateSessions() {
            const batchNo = getCurrentBatch();
            const day = getCurrentDay();
            const phase = getCurrentPhase();
            const sessionsDiv = document.getElementById('sessions');
            sessionsDiv.innerHTML = "";
            if (!phase || !day || day === "7") return;
            const dayKey = "Day " + day;
            const dayTopics = sessionData[phase] && sessionData[phase][dayKey];
            if (!dayTopics) return;

            const isLocked = await isDayLocked(batchNo, phase, day);
            if (isLocked) {
                sessionsDiv.innerHTML += `<div class="locked-notice">‚ö†Ô∏è This day is locked and cannot be edited.</div>`;
            }

            if (!batchData[batchNo][day]) batchData[batchNo][day] = { sessions: Array(4).fill({ trainer: "", topic: "" }) };
            batchData[batchNo][day].phase = phase;

            const trainers = await fetchTrainers();

            for (let i = 0; i < dayTopics.length; i++) {
                if (!dayTopics[i]) continue;
                let sdata = batchData[batchNo][day].sessions[i] || { trainer: "", topic: "" };
                let topicText = dayTopics[i];
                let splitPos = topicText.indexOf(',');
                if (splitPos === -1) splitPos = Math.min(topicText.length, 30);
                if (splitPos < topicText.length) {
                    topicText = topicText.substring(0, splitPos+1) + "<br>" + topicText.substring(splitPos+1);
                }
                sessionsDiv.innerHTML += `
                    <div class="session-row">
                        <div class="session-title">Session ${i+1}</div>
                        <select class="trainer" id="trainer-${i}" onchange="saveSessionData(${i})" ${isLocked ? 'disabled' : ''}>
                            <option value="">Select Trainer</option>
                            ${trainers.map(t => `<option value="${t.name}" ${t.name===sdata.trainer?'selected':''}>${t.name}</option>`).join('')}
                        </select>
                        <div class="topic">${topicText}</div>
                    </div>
                `;
            }

            if (isLocked) {
                const allow = await requestEditUnlock(batchNo, phase, day);
                if (allow) {
                    await updateSessions();
                }
            }
        }

        // Save session data to both memory and Firestore
        async function saveSessionData(idx) {
            const batchNo = getCurrentBatch();
            const day = getCurrentDay();
            const trainer = document.getElementById(`trainer-${idx}`).value;
            const phase = getCurrentPhase();
            const dayKey = "Day " + day;
            const topic = sessionData[phase][dayKey][idx];
            if (!batchData[batchNo][day]) batchData[batchNo][day] = { sessions: Array(4).fill({ trainer: "", topic: "" }) };
            batchData[batchNo][day].sessions[idx] = { trainer, topic };

            // Calculate the date for this day, skipping Sundays
            let startDate = document.getElementById('startDate').value;
            if (!startDate) return;
            let currentDate = new Date(startDate);
            for (let i = 1; i < parseInt(day); i++) {
                currentDate.setDate(currentDate.getDate() + 1);
                while (currentDate.getDay() === 0) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            let sessionDate = currentDate.toISOString().slice(0, 10);
            // Save to Firestore
            try {
                await db.collection('sessions').add({
                    batchNo,
                    day,
                    sessionIdx: idx,
                    trainer,
                    topic,
                    phase,
                    date: sessionDate,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error saving session:', error);
            }
        }

        // Show and close new trainer modal
        function showNewTrainerModal() { document.getElementById('newTrainerModal').style.display = 'block'; }
        function closeNewTrainerModal() { document.getElementById('newTrainerModal').style.display = 'none'; }
        function showRemoveTrainerModal() { document.getElementById('removeTrainerModal').style.display = 'block'; }
        function closeRemoveTrainerModal() { document.getElementById('removeTrainerModal').style.display = 'none'; }
        function showRemoveAllDataModal() { document.getElementById('removeAllDataModal').style.display = 'block'; }
        function closeRemoveAllDataModal() { document.getElementById('removeAllDataModal').style.display = 'none'; }
        function showReportModal(html) {
            document.getElementById('reportBody').innerHTML = html;
            document.getElementById('reportModal').style.display = 'block';
        }
        function closeReportModal() { document.getElementById('reportModal').style.display = 'none'; }
        function printReport() {
            const printWindow = window.open('', '', 'width=900,height=700');
            printWindow.document.write('<html><head><title>Report</title>');
            printWindow.document.write('<style>body{font-family:Arial,sans-serif;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #333;padding:8px;} th{background:#e9ecef;} .page-break{page-break-after:always;} .cell-topic{font-weight:bold;} .cell-trainer{font-size:0.9em;color:#555;} .signature-block{margin-top:40px;} .signature-line{border-top:1px solid #000;width:80%;margin:0 auto;padding-top:40px;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(document.getElementById('reportBody').innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        // Add signature block to reports
        function addSignatureBlock(html) {
            return html + `
                <div class="signature-block">
                    <table style="width: 100%; border-collapse: collapse; border: none;">
                        <tr>
                            <td style="width: 33%; text-align: center; border: none;">
                                <div class="signature-line">
                                    <span style="font-weight: bold;">Assistant Officer</span>
                                </div>
                            </td>
                            <td style="width: 33%; text-align: center; border: none;">
                                <div class="signature-line">
                                    <span style="font-weight: bold;">Regional Officer</span>
                                </div>
                            </td>
                            <td style="width: 33%; text-align: center; border: none;">
                                <div class="signature-line">
                                    <span style="font-weight: bold;">Deputy Secretary</span>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            `;
        }

        // --- Analytics Functions ---

        // Sessions taken by a particular trainer
        async function getSessionsByTrainer(trainerName) {
            const querySnapshot = await db.collection('sessions')
                .where('trainer', '==', trainerName)
                .get();
            return querySnapshot.docs.map(doc => doc.data());
        }

        // Past month sessions
        async function getPastMonthSessions() {
            const now = new Date();
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const querySnapshot = await db.collection('sessions')
                .where('date', '>=', lastMonth.toISOString().slice(0, 10))
                .where('date', '<=', now.toISOString().slice(0, 10))
                .get();
            return querySnapshot.docs.map(doc => doc.data());
        }

        // Average sessions per trainer
        async function getAverageSessionsPerTrainer() {
            const trainers = await fetchTrainers();
            const sessions = await db.collection('sessions').get();
            const sessionsByTrainer = {};
            sessions.forEach(doc => {
                const trainer = doc.data().trainer;
                sessionsByTrainer[trainer] = (sessionsByTrainer[trainer] || 0) + 1;
            });
            const totalSessions = sessions.size;
            const avg = trainers.length > 0 ? (totalSessions / trainers.length) : 0;
            return { avg, sessionsByTrainer };
        }

        // Total sessions conducted in a month
        async function getTotalSessionsInMonth(year, month) {
            const startDate = new Date(year, month - 1, 1).toISOString().slice(0, 10);
            const endDate = new Date(year, month, 0).toISOString().slice(0, 10);
            const querySnapshot = await db.collection('sessions')
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get();
            return querySnapshot.size;
        }

        // Export trainer master data
        async function exportTrainerMasterData() {
            const trainers = await fetchTrainers();
            const blob = new Blob([JSON.stringify(trainers, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trainer_master_data.json';
            a.click();
        }

        // Export all training data (trainers + sessions)
        async function exportAllTrainingData() {
            const trainers = await fetchTrainers();
            const sessions = await db.collection('sessions').get();
            const data = {
                trainers: trainers,
                sessions: sessions.docs.map(doc => doc.data())
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'training_data_export.json';
            a.click();
        }

        // --- Analytics UI Handlers ---

        async function showSessionsByTrainer() {
            const trainerName = document.getElementById('analyticsTrainer').value;
            if (!trainerName) {
                alert('Please select a trainer');
                return;
            }
            const sessions = await getSessionsByTrainer(trainerName);
            const html = `<h4>Sessions by ${trainerName}</h4><pre>${JSON.stringify(sessions, null, 2)}</pre>`;
            document.getElementById('analyticsResult').innerHTML = html;
        }

        async function showPastMonthSessions() {
            const sessions = await getPastMonthSessions();
            const html = `<h4>Past Month Sessions</h4><pre>${JSON.stringify(sessions, null, 2)}</pre>`;
            document.getElementById('analyticsResult').innerHTML = html;
        }

        async function showAverageSessions() {
            const result = await getAverageSessionsPerTrainer();
            const html = `<h4>Average Sessions per Trainer</h4>
                          <p>Average: ${result.avg.toFixed(2)}</p>
                          <h5>Sessions by Trainer</h5>
                          <pre>${JSON.stringify(result.sessionsByTrainer, null, 2)}</pre>`;
            document.getElementById('analyticsResult').innerHTML = html;
        }

        async function showTotalSessionsInMonth() {
            const year = prompt('Enter year (e.g., 2025):');
            const month = prompt('Enter month (1-12):');
            if (!year || !month) return;
            const total = await getTotalSessionsInMonth(parseInt(year), parseInt(month));
            document.getElementById('analyticsResult').innerHTML = `<h4>Total Sessions in ${month}/${year}</h4><p>Total: ${total}</p>`;
        }

        // --- Report Generation ---

        async function generateDailyReport() {
            let batchNo = getCurrentBatch();
            let day = getCurrentDay();
            let phase = getCurrentPhase();
            let startDate = document.getElementById('startDate').value;
            let endDate = document.getElementById('endDate').value;
            let dayNum = parseInt(day, 10);

            // Calculate the date for this day, skipping Sundays
            let currentDate = new Date(startDate);
            for (let i = 1; i < dayNum; i++) {
                currentDate.setDate(currentDate.getDate() + 1);
                while (currentDate.getDay() === 0) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            let sessionDate = currentDate.toISOString().slice(0, 10);
            let sessionRows = "";
            for (let i = 0; i < 4; i++) {
                let sdata = batchData[batchNo][day] ? batchData[batchNo][day].sessions[i] || { trainer: "", topic: "" } : { trainer: "", topic: "" };
                sessionRows += `<tr>
                    <td>Session ${i+1}</td>
                    <td>${sdata.topic||""}</td>
                    <td>${sdata.trainer||""}</td>
                    <td style="height:40px;"></td>
                </tr>`;
            }
            let html = `
                <h2 style="text-align:center;">Institute of Entrepreneurship Development, Bihar</h2>
                <h3 style="text-align:center;">TRAINER ATTENDANCE</h3>
                <table style="width:100%;margin-bottom:18px;">
                    <tr>
                        <td><b>Room No.:</b> ${batchNo}</td>
                        <td><b>Training Duration:</b> ${formatDateToDDMMYYYY(startDate)} - ${formatDateToDDMMYYYY(endDate)}</td>
                    </tr>
                    <tr>
                        <td><b>Training Day:</b> Day ${day}</td>
                        <td><b>Date:</b> ${formatDateToDDMMYYYY(sessionDate)}</td>
                    </tr>
                    <tr>
                        <td><b>Training Phase:</b> ${phase}</td>
                        <td></td>
                    </tr>
                </table>
                <table style="width:100%;border-collapse:collapse;">
                    <tr>
                        <th>Session</th>
                        <th>Topic</th>
                        <th>Trainer</th>
                        <th>Signature</th>
                    </tr>
                    ${sessionRows}
                </table>
            `;
            showReportModal(addSignatureBlock(html));

            // Lock the day after report generation
            await lockDay(batchNo, phase, day);
        }

        // Generate Weekly Report (single training duration, room number wise, trainer below topic)
        async function generateWeeklyReport() {
            let phase = getCurrentPhase();
            let startDate = document.getElementById('startDate').value;
            let endDate = document.getElementById('endDate').value;
            let html = `
                <h2 style="text-align:center;">Institute of Entrepreneurship Development, Bihar</h2>
                <h3 style="text-align:center;">TRAINER ATTENDANCE - WEEKLY REPORT</h3>
                <div style="text-align:center;margin-bottom:20px;">
                    <strong>Training Duration: ${formatDateToDDMMYYYY(startDate)} - ${formatDateToDDMMYYYY(endDate)}</strong><br>
                    <strong>Training Phase: ${phase}</strong>
                </div>
            `;

            // Calculate dates for each day, skipping Sundays
            let currentDate = new Date(startDate);
            let trainingDays = [];
            for (let d = 1; d <= 6; d++) {
                let dateStr = currentDate.toISOString().slice(0, 10);
                trainingDays.push({ day: d, date: dateStr });
                currentDate.setDate(currentDate.getDate() + 1);
                while (currentDate.getDay() === 0) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }

            // For each room (batch)
            for (let b = 1; b <= 4; b++) {
                let hasAnyTrainer = false;
                for (let d = 1; d <= 6; d++) {
                    if (batchData[b][d] && hasTrainerAssigned(b, d)) {
                        hasAnyTrainer = true;
                        break;
                    }
                }
                if (!hasAnyTrainer) continue;
                html += `<h4 style="text-align:center;background:#e9ecef;padding:10px;">Room ${b}</h4>`;
                html += `<table style="width:100%;border-collapse:collapse;margin-bottom:30px;">`;
                html += `<tr><th>Day/Date</th><th>Session 1</th><th>Session 2</th><th>Session 3</th><th>Session 4</th></tr>`;

                for (let d = 1; d <= 6; d++) {
                    if (!batchData[b][d] || !hasTrainerAssigned(b, d)) continue;
                    let phase = batchData[b][d].phase || getCurrentPhase();
                    let dayKey = "Day " + d;
                    let dayTopics = sessionData[phase] && sessionData[phase][dayKey];
                    if (!dayTopics) continue;
                    let dateStr = trainingDays[d-1] ? formatDateToDDMMYYYY(trainingDays[d-1].date) : "";
                    html += `<tr>
                        <td><strong>Day ${d}<br>${dateStr}</strong></td>`;
                    for (let s = 0; s < 4; s++) {
                        if (!dayTopics[s]) continue;
                        let trainer = batchData[b][d].sessions[s] ? batchData[b][d].sessions[s].trainer || "" : "";
                        html += `<td>
                            <div class="cell-topic">${dayTopics[s]}</div>
                            <div class="cell-trainer">${t.trainer}</div>
                        </td>`;
                    }
                    html += `</tr>`;
                }
                html += `</table>`;
            }
            showReportModal(addSignatureBlock(html));
        }

        function hasTrainerAssigned(batch, day) {
            if (!batchData[batch][day]) return false;
            for (let s = 0; s < 4; s++) {
                if (batchData[batch][day].sessions[s] && batchData[batch][day].sessions[s].trainer && batchData[batch][day].sessions[s].trainer.trim()) {
                    return true;
                }
            }
            return false;
        }

        async function generate7DaySummary() {
            const trainers = await fetchTrainers();
            let summary = {};
            trainers.forEach(t => summary[t.name] = {sessions: 0, ifsc: t.ifsc, bank: t.bank});
            for (let b = 1; b <= 4; b++) {
                for (let d = 1; d <= 6; d++) {
                    if (batchData[b][d] && batchData[batch][day].sessions) {
                        batchData[b][d].sessions.forEach(s => {
                            if (s.trainer && summary[s.trainer]) summary[s.trainer].sessions++;
                        });
                    }
                }
            }
            let html = `
                <h2 style="text-align:center;">Institute of Entrepreneurship Development, Bihar</h2>
                <h3 style="text-align:center;">TRAINER ATTENDANCE - 7-DAY SUMMARY</h3>
                <table style="width:100%;border-collapse:collapse;">
                    <tr>
                        <th>S.No.</th>
                        <th>Trainer Name</th>
                        <th>Total Sessions Taken</th>
                        <th>Rate per Session (Rs.)</th>
                        <th>Total Honorarium</th>
                        <th>IFSC Code</th>
                        <th>Bank Account</th>
                        <th>Signature</th>
                    </tr>
            `;
            let sn = 1;
            for (const t of trainers) {
                let rate = t.name.trim().toLowerCase() === "ied bihar staff" ? 0 : 500;
                let total = summary[t.name] ? summary[t.name].sessions : 0;
                html += `<tr>
                    <td>${sn++}</td>
                    <td>${t.name}</td>
                    <td>${total}</td>
                    <td>${rate}</td>
                    <td>${rate*total}</td>
                    <td>${t.ifsc||""}</td>
                    <td>${t.bank||""}</td>
                    <td style="height:40px;"></td>
                </tr>`;
            }
            html += `</table>`;
            showReportModal(addSignatureBlock(html));
        }

        async function generateMonthlySummary() {
            let durations = [
                {start: "2025-06-01", end: "2025-06-07"},
                {start: "2025-06-15", end: "2025-06-21"}
            ];
            let monthName = "June 2025";
            const trainers = await fetchTrainers();
            let trainerMap = {};
            trainers.forEach(t => trainerMap[t.name] = {ifsc: t.ifsc, bank: t.bank, perDuration: [0,0], total: 0});
            durations.forEach((dur, idx) => {
                for (let b = 1; b <= 4; b++) {
                    for (let d = 1; d <= 6; d++) {
                        if (batchData[b][d] && batchData[b][d].sessions) {
                            batchData[b][d].sessions.forEach(s => {
                                if (s.trainer && trainerMap[s.trainer]) {
                                    trainerMap[s.trainer].perDuration[idx]++;
                                    trainerMap[s.trainer].total++;
                                }
                            });
                        }
                    }
                }
            });
            let html = `
                <h2 style="text-align:center;">Institute of Entrepreneurship Development, Bihar</h2>
                <h3 style="text-align:center;">TRAINER ATTENDANCE - MONTHLY SUMMARY (${monthName})</h3>
                <table style="width:100%;border-collapse:collapse;">
                    <tr>
                        <th rowspan="2">S.No.</th>
                        <th rowspan="2">Trainer Name</th>
                        <th colspan="${durations.length}">Total Sessions Taken (Training Duration)</th>
                        <th rowspan="2">Total Sessions in Month</th>
                        <th rowspan="2">Rate per Session (Rs.)</th>
                        <th rowspan="2">Total Monthly Honorarium</th>
                        <th rowspan="2">IFSC Code</th>
                        <th rowspan="2">Bank Account</th>
                        <th rowspan="2">Signature</th>
                    </tr>
                    <tr>
                        ${durations.map(d=>`<th>${d.start} - ${d.end}</th>`).join('')}
                    </tr>
            `;
            let sn = 1;
            for (const t of trainers) {
                let rate = t.name.trim().toLowerCase() === "ied bihar staff" ? 0 : 500;
                let total = trainerMap[t.name] ? trainerMap[t.name].total : 0;
                html += `<tr>
                    <td>${sn++}</td>
                    <td>${t.name}</td>
                    ${trainerMap[t.name].perDuration.map(cnt=>`<td>${cnt}</td>`).join('')}
                    <td>${total}</td>
                    <td>${rate}</td>
                    <td>${rate*total}</td>
                    <td>${t.ifsc||""}</td>
                    <td>${t.bank||""}</td>
                    <td style="height:40px;"></td>
                </tr>`;
            }
            html += `</table>`;
            showReportModal(addSignatureBlock(html));
        }

        // Setup app after page load
        function setupApp() {
            console.log('setupApp called');
            document.getElementById('addTrainerBtn').onclick = showNewTrainerModal;
            document.getElementById('removeTrainerBtn').onclick = showRemoveTrainerModal;
            document.getElementById('removeAllDataBtn').onclick = showRemoveAllDataModal;
            document.getElementById('exportDataBtn').onclick = exportAllTrainingData;
            document.getElementById('adminLoginBtn').onclick = showAdminLoginModal;
            document.getElementById('batchPhase').onchange = updateDays;
            document.getElementById('batchNo').onchange = updateSessions;
            document.getElementById('dayNo').onchange = updateSessions;
            updateTrainerDropdowns();
        }

        // Handle new trainer form submission
        document.getElementById('newTrainerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('nt_name').value.trim();
            const mobile = document.getElementById('nt_mobile').value.trim();
            const bank = document.getElementById('nt_bank').value.trim();
            const ifsc = document.getElementById('nt_ifsc').value.trim().toUpperCase();
            if (!name || !mobile || !bank || !ifsc) {
                alert('Please fill all fields');
                return;
            }
            const querySnapshot = await db.collection('trainers').where('mobile', '==', mobile).get();
            if (!querySnapshot.empty) {
                alert('A trainer with this mobile number already exists!');
                return;
            }
            try {
                await db.collection('trainers').add({
                    name,
                    mobile,
                    bank,
                    ifsc,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Trainer registered successfully!');
                closeNewTrainerModal();
                document.getElementById('newTrainerForm').reset();
                await updateTrainerDropdowns();
            } catch (error) {
                alert('Error registering trainer: ' + error.message);
            }
        });

        // Handle remove trainer form submission
        document.getElementById('removeTrainerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const trainerId = document.getElementById('rt_id').value;
            if (!trainerId) {
                alert('Please select a trainer to remove');
                return;
            }
            if (!confirm('Are you sure you want to remove this trainer? This action cannot be undone.')) {
                return;
            }
            try {
                await db.collection('trainers').doc(trainerId).delete();
                alert('Trainer removed successfully!');
                closeRemoveTrainerModal();
                await updateTrainerDropdowns();
            } catch (error) {
                alert('Error removing trainer: ' + error.message);
            }
        });

        // Delete all training data
        async function removeAllTrainingData() {
            if (!confirm('Are you sure you want to delete all training data? This action cannot be undone. Please ensure you have saved all necessary reports before proceeding.')) {
                return;
            }
            try {
                const trainersDeleted = await deleteAllDocuments('trainers');
                const sessionsDeleted = await deleteAllDocuments('sessions');
                if (trainersDeleted && sessionsDeleted) {
                    alert('All training data has been removed successfully!');
                    batchData = {};
                    await updateTrainerDropdowns();
                } else {
                    alert('Error removing training data. Please try again.');
                }
            } catch (error) {
                alert('Error removing training data: ' + error.message);
            } finally {
                closeRemoveAllDataModal();
            }
        }

        // Helper: Delete all documents in a collection
        async function deleteAllDocuments(collectionName) {
            try {
                const snapshot = await db.collection(collectionName).get();
                const batch = db.batch();
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                return true;
            } catch (error) {
                console.error('Error deleting documents:', error);
                return false;
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', setupApp);
    </script>
</body>
</html>

